<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanctum Veritatis</title>
  <style>
    :root{
      --bg:#050507;
      --panel:#0b0b10;
      --gold:#d7b35a;
      --gold2:#b78d2f;
      --text:#efe7d1;
      --muted:#9b8f73;
      --danger:#ff4d4d;
      --ok:#66ffb3;
      --line:rgba(215,179,90,.18);
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 70% 20%, rgba(215,179,90,.08), transparent 60%),
        radial-gradient(900px 500px at 20% 80%, rgba(183,141,47,.06), transparent 55%),
        linear-gradient(180deg, #030305, var(--bg));
      color:var(--text);
      font-family:var(--sans);
      overflow:hidden;
    }

    .grain::before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      opacity:.07;
      mix-blend-mode:overlay;
      pointer-events:none;
    }

    .app{
      height:100%;
      display:grid;
      place-items:center;
      padding:22px;
    }

    .frame{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(11,11,16,.86), rgba(6,6,9,.78));
      box-shadow:var(--shadow);
      border-radius:18px;
      overflow:hidden;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(90deg, rgba(215,179,90,.08), transparent 45%);
    }
    header .brand{
      display:flex; gap:12px; align-items:center;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:650;
      color:var(--gold);
    }
    .sigil{
      width:34px; height:34px; border-radius:10px;
      border:1px solid rgba(215,179,90,.35);
      background:
        radial-gradient(circle at 30% 30%, rgba(215,179,90,.35), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(215,179,90,.16), transparent 55%),
        linear-gradient(180deg, rgba(215,179,90,.10), rgba(0,0,0,.35));
      box-shadow:0 0 0 1px rgba(0,0,0,.35) inset;
      position:relative;
    }
    .sigil:after{
      content:"";
      position:absolute; inset:7px;
      border:1px dashed rgba(215,179,90,.40);
      border-radius:8px;
      opacity:.85;
    }

    header .status{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    header .status b{ color:var(--gold); font-weight:650 }

    main{
      min-height:560px;
      padding:18px;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(215,179,90,.03));
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns: 1fr; }
    }

    .title{
      margin:0 0 10px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
      font-size:14px;
    }
    .hint{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin:10px 0;
    }
    label{
      font-size:12px;
      color:rgba(239,231,209,.75);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    input, button{
      border-radius:12px;
      border:1px solid rgba(215,179,90,.22);
      background:rgba(0,0,0,.35);
      color:var(--text);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    input{
      font-family:var(--mono);
    }
    input:focus{
      border-color:rgba(215,179,90,.55);
      box-shadow:0 0 0 4px rgba(215,179,90,.12);
    }
    button{
      cursor:pointer;
      font-weight:650;
      letter-spacing:.06em;
      text-transform:uppercase;
      background:linear-gradient(180deg, rgba(215,179,90,.22), rgba(0,0,0,.35));
      transition:.15s transform ease, .15s filter ease;
    }
    button:hover{ filter:brightness(1.08); }
    button:active{ transform:translateY(1px); }

    .danger{
      border-color:rgba(255,77,77,.35);
      background:linear-gradient(180deg, rgba(255,77,77,.12), rgba(0,0,0,.35));
    }

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(215,179,90,.18);
      background:rgba(0,0,0,.25);
      color:rgba(239,231,209,.86);
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      min-height:42px;
      white-space:pre-wrap;
    }

    /* Welcome */
    .welcomeWrap{
      display:grid;
      place-items:center;
      min-height:520px;
      position:relative;
    }
    .welcomeText{
      font-family:var(--mono);
      font-size:26px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 18px rgba(215,179,90,.18);
      opacity:0;
      animation: fadeIn .9s ease forwards;
    }
    @keyframes fadeIn { to{opacity:1} }

    .scanline{
      position:absolute; inset:-20%;
      background: linear-gradient(transparent 48%, rgba(215,179,90,.10) 50%, transparent 52%);
      background-size: 100% 18px;
      opacity:.25;
      animation: scan 2.6s linear infinite;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    @keyframes scan {
      from{ transform: translateY(-30px); }
      to{ transform: translateY(30px); }
    }

    /* Location */
    .locBox{
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.30);
      padding:14px;
      font-family:var(--mono);
      font-size:13px;
      color:rgba(239,231,209,.88);
      white-space:pre-wrap;
      line-height:1.55;
      min-height:110px;
    }

    /* Chat */
    .chatWrap{
      display:grid;
      grid-template-rows: 1fr auto;
      gap:10px;
      min-height:520px;
    }
    .chatLog{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.25);
      padding:12px;
      overflow:auto;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.5;
    }
    .chatRow{
      display:flex;
      gap:10px;
    }
    .chatRow input{ flex:1; }

    /* Overlays */
    .overlay{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      z-index:20;
    }
    .overlay.active{ display:grid; }
    .overlay .box{
      width:min(720px, 92%);
      border-radius:18px;
      border:1px solid rgba(255,77,77,.25);
      background:linear-gradient(180deg, rgba(16,0,0,.55), rgba(0,0,0,.60));
      box-shadow:var(--shadow);
      padding:18px;
    }
    .overlay .box .big{
      font-family:var(--mono);
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#ffb3b3;
      margin:0 0 8px;
      font-size:16px;
    }
    .overlay .box .small{
      margin:0;
      color:rgba(239,231,209,.75);
      font-size:13px;
      line-height:1.55;
      font-family:var(--mono);
    }

    /* Breach / Glitch */
    .breach{
      min-height:520px;
      border-radius:18px;
      border:1px solid rgba(215,179,90,.16);
      background:
        radial-gradient(900px 420px at 20% 30%, rgba(255,77,77,.08), transparent 60%),
        radial-gradient(800px 420px at 80% 70%, rgba(215,179,90,.06), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      position:relative;
      overflow:hidden;
    }
    .breach::before{
      content:"";
      position:absolute; inset:-10%;
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,.035) 0px,
          rgba(255,255,255,.035) 1px,
          transparent 2px,
          transparent 5px);
      opacity:.25;
      mix-blend-mode:overlay;
      animation: drift 1.2s linear infinite;
      pointer-events:none;
    }
    @keyframes drift {
      from { transform: translateY(-14px); }
      to { transform: translateY(14px); }
    }
    .breachInner{
      position:relative;
      padding:18px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .glitchTitle{
      font-family:var(--mono);
      color:rgba(239,231,209,.90);
      letter-spacing:.14em;
      text-transform:uppercase;
      margin:0;
      font-size:14px;
    }
    .glitchBar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,77,77,.22);
      background:
        linear-gradient(90deg, rgba(255,77,77,.35), rgba(215,179,90,.18), rgba(255,77,77,.35));
      animation: bar 1.1s linear infinite;
      opacity:.85;
    }
    @keyframes bar {
      0%{ filter:hue-rotate(0deg); transform:translateX(-2px); }
      50%{ filter:hue-rotate(25deg); transform:translateX(2px); }
      100%{ filter:hue-rotate(0deg); transform:translateX(-2px); }
    }

    .popLayer{
      position:absolute; inset:0;
      pointer-events:none;
      z-index:6;
    }
    .popup{
      position:absolute;
      width:min(360px, 70vw);
      border-radius:12px;
      border:1px solid rgba(255,77,77,.30);
      background:linear-gradient(180deg, rgba(25,0,0,.72), rgba(0,0,0,.72));
      box-shadow:0 16px 40px rgba(0,0,0,.55);
      padding:10px 10px 12px;
      pointer-events:auto;
    }
    .popup .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-family:var(--mono);
      text-transform:uppercase;
      letter-spacing:.10em;
      font-size:12px;
      color:rgba(255,190,190,.92);
    }
    .popup .x{
      pointer-events:auto;
      cursor:pointer;
      border-radius:10px;
      padding:4px 8px;
      border:1px solid rgba(255,77,77,.28);
      background:rgba(0,0,0,.25);
      color:rgba(255,210,210,.92);
      font-family:var(--mono);
    }
    .popup .body{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(239,231,209,.80);
      line-height:1.45;
    }

    /* Terminal */
    .terminal{
      min-height:560px;
      border-radius:18px;
      border:1px solid rgba(215,179,90,.20);
      background:rgba(0,0,0,.55);
      overflow:hidden;
      display:grid;
      grid-template-rows:auto 1fr auto;
    }
    .termTop{
      padding:12px 14px;
      border-bottom:1px solid rgba(215,179,90,.18);
      font-family:var(--mono);
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
      background:linear-gradient(90deg, rgba(215,179,90,.08), transparent 55%);
    }
    .termOut{
      padding:14px;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.55;
      color:rgba(239,231,209,.90);
      overflow:auto;
      white-space:pre-wrap;
    }
    .termIn{
      border-top:1px solid rgba(215,179,90,.18);
      display:flex;
      gap:10px;
      padding:10px;
      background:rgba(0,0,0,.30);
    }
    .prompt{
      font-family:var(--mono);
      color:rgba(215,179,90,.92);
      padding:10px 0 0 6px;
      white-space:nowrap;
    }
    .termIn input{
      flex:1;
      border-radius:12px;
      border:1px solid rgba(215,179,90,.22);
      background:rgba(0,0,0,.40);
      color:var(--text);
      font-family:var(--mono);
      padding:12px;
    }

    /* Locked */
    .locked{
      min-height:520px;
      display:grid;
      place-items:center;
      text-align:center;
      padding:40px 18px;
    }
    .locked h2{
      margin:0 0 10px;
      font-family:var(--mono);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#ffb3b3;
      font-size:18px;
    }
    .locked p{
      margin:0;
      color:rgba(239,231,209,.70);
      font-family:var(--mono);
      line-height:1.6;
      max-width:62ch;
    }

    /* subtle shake */
    .shake{ animation: shake .16s linear 0s 3; }
    @keyframes shake{
      0%{ transform:translate(0,0) }
      25%{ transform:translate(2px,-1px) }
      50%{ transform:translate(-2px,1px) }
      75%{ transform:translate(2px,1px) }
      100%{ transform:translate(0,0) }
    }
  </style>
</head>

<body class="grain">
  <div class="app">
    <div class="frame" id="frame">
      <header>
        <div class="brand">
          <div class="sigil" aria-hidden="true"></div>
          <div>Sanctum Veritatis</div>
        </div>
        <div class="status"><b id="statusTag">OFFLINE</b> · <span id="statusDetail">aguardando identificação</span></div>
      </header>

      <div class="overlay" id="overlayCut">
        <div class="box">
          <p class="big">Conexão interrompida</p>
          <p class="small">A Ordo encerrou o canal. Credenciais revogadas. Sincronização abortada.</p>
        </div>
      </div>

      <main>
        <!-- LOCK SOFT/HARD -->
        <section class="screen" id="screenLocked">
          <div class="locked">
            <div>
              <h2>Acesso bloqueado</h2>
              <p>O nó atual está inacessível. Estado preservado no dispositivo local.</p>
            </div>
          </div>
        </section>

        <!-- LOGIN -->
        <section class="screen" id="screenLogin">
          <div class="grid">
            <div class="panel">
              <h3 class="title">Protocolo de entrada</h3>
              <p class="hint">Informe a identificação e a senha. A autenticação ocorre nesta instância.</p>

              <div class="field">
                <label for="user">Identificação</label>
                <input id="user" autocomplete="off" spellcheck="false" />
              </div>
              <div class="field">
                <label for="pass">Senha</label>
                <input id="pass" type="password" autocomplete="off" />
              </div>

              <button id="btnLogin">Autorizar</button>
              <div class="msg" id="loginMsg"></div>
            </div>

            <div class="panel">
              <h3 class="title">Diretiva</h3>
              <p class="hint">A interface opera em modo discreto, com registro local e transições restritas.</p>
              <div class="msg" id="sysNote">
                Canal: SV-PRIME
                \nCriptografia: habilitada
                \nSessão: não iniciada
              </div>
            </div>
          </div>
        </section>

        <!-- WELCOME -->
        <section class="screen" id="screenWelcome">
          <div class="welcomeWrap panel">
            <div class="scanline" aria-hidden="true"></div>
            <div class="welcomeText" id="welcomeText">BEM-VINDO, AGENTE</div>
            <div class="msg" id="welcomeSub" style="margin-top:18px; max-width:76ch; text-align:center;">
              Inicializando rastreio de presença...
            </div>
          </div>
        </section>

        <!-- LOCATION -->
        <section class="screen" id="screenLoc">
          <div class="panel">
            <h3 class="title">Localização operacional</h3>
            <p class="hint">Aguardando leitura do dispositivo.</p>
            <div class="locBox" id="locBox">Solicitando permissão...</div>
            <div style="display:flex; gap:10px; margin-top:12px;">
              <button id="btnLocContinue">Prosseguir</button>
              <button class="danger" id="btnLocRetry">Repetir leitura</button>
            </div>
          </div>
        </section>

        <!-- CHAT -->
        <section class="screen" id="screenChat">
          <div class="chatWrap">
            <div class="chatLog" id="chatLog"></div>
            <div class="chatRow">
              <input id="chatInput" autocomplete="off" spellcheck="false" placeholder="Transmitir..." />
              <button id="btnSend">Enviar</button>
            </div>
          </div>
        </section>

        <!-- BREACH -->
        <section class="screen" id="screenBreach">
          <div class="breach">
            <div class="popLayer" id="popLayer"></div>
            <div class="breachInner">
              <h3 class="glitchTitle">Sincronização comprometida</h3>
              <div class="glitchBar" aria-hidden="true"></div>
              <div class="panel" style="background:rgba(0,0,0,.25);">
                <p class="hint" style="margin:0 0 10px; font-family:var(--mono);">
                  Interferência detectada. Execute a rotina de sincronização.
                </p>
                <div class="field" style="margin:0 0 12px;">
                  <label for="syncKey">Chave de sincronização</label>
                  <input id="syncKey" autocomplete="off" spellcheck="false" placeholder="ex: 9f3a-..." />
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button id="btnSync">Sincronizar</button>
                  <button class="danger" id="btnForce">Forçar canal</button>
                </div>
                <div class="msg" id="breachMsg"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- TERMINAL -->
        <section class="screen" id="screenTerm">
          <div class="terminal">
            <div class="termTop">Terminal // SV-SHELL</div>
            <div class="termOut" id="termOut"></div>
            <div class="termIn">
              <div class="prompt" id="prompt"></div>
              <input id="termCmd" autocomplete="off" spellcheck="false" />
              <button id="btnTermRun">Executar</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

<script>
(() => {
  // Credenciais (apenas local, sem backend)
  const USERS = [
    { id: "Eliar", pass: "333", codename: "Eliar" },
    { id: "ScottBrigues", pass: "Territorio46", codename: "ScottBrigues" },
    { id: "Isaac oliveira", pass: "DE NOVO", codename: "Isaac Oliveira" }
  ];

  const LS = {
    lock: "sv_lock_state",       // "none" | "soft" | "hard"
    user: "sv_last_user",
    breachFails: "sv_breach_fails",
    termFails: "sv_term_fails"
  };

  const $ = (id) => document.getElementById(id);

  const screens = {
    locked: $("screenLocked"),
    login: $("screenLogin"),
    welcome: $("screenWelcome"),
    loc: $("screenLoc"),
    chat: $("screenChat"),
    breach: $("screenBreach"),
    term: $("screenTerm")
  };

  const statusTag = $("statusTag");
  const statusDetail = $("statusDetail");
  const frame = $("frame");

  const overlayCut = $("overlayCut");

  const loginMsg = $("loginMsg");
  const sysNote = $("sysNote");
  const userIn = $("user");
  const passIn = $("pass");
  const btnLogin = $("btnLogin");

  const welcomeSub = $("welcomeSub");

  const locBox = $("locBox");
  const btnLocContinue = $("btnLocContinue");
  const btnLocRetry = $("btnLocRetry");

  const chatLog = $("chatLog");
  const chatInput = $("chatInput");
  const btnSend = $("btnSend");

  const popLayer = $("popLayer");
  const breachMsg = $("breachMsg");
  const syncKey = $("syncKey");
  const btnSync = $("btnSync");
  const btnForce = $("btnForce");

  const termOut = $("termOut");
  const termCmd = $("termCmd");
  const btnTermRun = $("btnTermRun");
  const prompt = $("prompt");

  let sessionUser = null;

  // reset combo: Ctrl+Shift+R (limpa lock local)
  function tryResetCombo(ev){
    // Observação: alguns navegadores podem interceptar Ctrl+Shift+R como "hard reload".
    if (ev.ctrlKey && ev.shiftKey && (ev.key === "R" || ev.key === "r")) {
      localStorage.removeItem(LS.lock);
      localStorage.removeItem(LS.breachFails);
      localStorage.removeItem(LS.termFails);
      // mantém LS.user (opcional)
      location.reload();
    }
  }
  window.addEventListener("keydown", tryResetCombo);

  function getLockState(){
    return localStorage.getItem(LS.lock) || "none";
  }
  function setLockState(v){
    localStorage.setItem(LS.lock, v);
  }

  function showScreen(name){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[name].classList.add("active");
  }

  function setStatus(tag, detail){
    statusTag.textContent = tag;
    statusDetail.textContent = detail;
  }

  function boot(){
    const lock = getLockState();
    if (lock === "soft" || lock === "hard") {
      setStatus("LOCKED", "estado preservado");
      showScreen("locked");
      return;
    }
    setStatus("OFFLINE", "aguardando identificação");
    showScreen("login");
    const last = localStorage.getItem(LS.user);
    if (last) userIn.value = last;
    loginMsg.textContent = "Aguardando...";
  }

  function findUser(id, pass){
    const norm = (s) => (s || "").trim();
    const u = norm(id);
    const p = norm(pass);
    return USERS.find(x => x.id === u && x.pass === p) || null;
  }

  function login(){
    const u = userIn.value.trim();
    const p = passIn.value;
    const found = findUser(u,p);

    if (!found) {
      loginMsg.textContent = "Credenciais inválidas.\nVerifique a identificação e a senha.";
      frame.classList.add("shake");
      setTimeout(()=>frame.classList.remove("shake"), 240);
      return;
    }

    sessionUser = found;
    localStorage.setItem(LS.user, found.id);
    setStatus("ONLINE", "sessão iniciada");
    sysNote.textContent =
      "Canal: SV-PRIME\nCriptografia: habilitada\nSessão: ativa\nOperador: " + found.codename;

    showScreen("welcome");
    welcomeSub.textContent = "Validando presença...";

    setTimeout(() => {
      welcomeSub.textContent = "Mapeando ambiente...";
    }, 900);

    setTimeout(() => {
      showScreen("loc");
      startLocation();
    }, 1600);
  }

  function startLocation(){
    locBox.textContent = "Solicitando permissão...";
    const ts = new Date().toISOString();

    if (!navigator.geolocation) {
      locBox.textContent = "Geolocation indisponível neste ambiente.\nTimestamp: " + ts;
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude, accuracy } = pos.coords;
        const stamp = new Date(pos.timestamp).toISOString();
        locBox.textContent =
          "Leitura confirmada.\n" +
          "Latitude:  " + latitude + "\n" +
          "Longitude: " + longitude + "\n" +
          "Precisão:  ~" + Math.round(accuracy) + "m\n" +
          "Timestamp: " + stamp;
      },
      (err) => {
        locBox.textContent =
          "Falha na leitura.\n" +
          "Código: " + err.code + "\n" +
          "Detalhe: " + err.message + "\n" +
          "Timestamp: " + ts;
      },
      { enableHighAccuracy: true, timeout: 9000, maximumAge: 0 }
    );
  }

  function chatInit(){
    chatLog.textContent = "";
    const name = sessionUser?.codename || "AGENTE";
    chatLog.textContent += "[SV] Canal estabelecido.\n";
    chatLog.textContent += "[SV] Bem-vindo, " + name + ".\n";
    chatLog.textContent += "[SV] Transmita apenas o necessário.\n";
    chatLog.scrollTop = chatLog.scrollHeight;
    chatInput.value = "";
    chatInput.focus();
  }

  function cutConnection(){
    overlayCut.classList.add("active");
    setStatus("UNSTABLE", "credenciais revogadas");
    setTimeout(() => {
      overlayCut.classList.remove("active");
      showScreen("breach");
      beginBreach();
    }, 1300);
  }

  function addChatLine(prefix, text){
    chatLog.textContent += prefix + " " + text + "\n";
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function beginBreach(){
    breachMsg.textContent =
      "Canal degradado.\n" +
      "Erros: AUTH_LOST, SYNC_DRIFT, HANDSHAKE_ABORT\n" +
      "Ação requerida: sincronização manual.";
    syncKey.value = "";
    syncKey.focus();
  }

  function randomInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function spawnPopup(batch=10){
    for (let i=0;i<batch;i++){
      const p = document.createElement("div");
      p.className = "popup";
      const x = randomInt(20, 80);
      const y = randomInt(10, 75);
      p.style.left = x + "%";
      p.style.top  = y + "%";
      p.style.transform = "translate(-50%,-50%)";

      const code = [
        "SYNC_TIMEOUT",
        "CRC_MISMATCH",
        "AUTH_CONTEXT_LOST",
        "NULL_TOKEN",
        "CLOCK_SKEW",
        "STREAM_CORRUPTED",
        "MEMORY_PAGE_FAULT",
        "HANDSHAKE_OVERFLOW",
        "DESYNC_EVENT",
        "SIGNATURE_INVALID"
      ][randomInt(0,9)];

      const detail = "Erro: " + code + " / seq=" + randomInt(1000,9999) + " / node=" + randomInt(1,42);

      p.innerHTML = `
        <div class="top">
          <span>erro do sistema</span>
          <button class="x" type="button">fechar</button>
        </div>
        <div class="body">${detail}<br>Sincronização abortada.<br>Reinicie o canal.</div>
      `;

      const btn = p.querySelector(".x");
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        // ao tentar fechar, multiplica
        p.remove();
        spawnPopup(10);
        frame.classList.add("shake");
        setTimeout(()=>frame.classList.remove("shake"), 260);
      });

      popLayer.appendChild(p);
    }
  }

  function breachFail(){
    const fails = (parseInt(localStorage.getItem(LS.breachFails) || "0", 10) + 1);
    localStorage.setItem(LS.breachFails, String(fails));

    breachMsg.textContent =
      "Sincronização falhou.\n" +
      "Tentativa: " + fails + "/5\n" +
      "Rastreamento instável. Erros se propagando...";

    // glitch/popups cada vez mais agressivos
    spawnPopup(10 + fails * 8);
    frame.classList.add("shake");
    setTimeout(()=>frame.classList.remove("shake"), 260);

    // apesar do colapso, abre um shell de contingência
    if (fails >= 2) {
      setTimeout(() => openTerminal(), 900);
    }

    if (fails >= 5) {
      setLockState("soft");
      setStatus("LOCKED", "bloqueio aplicado");
      showScreen("locked");
    }
  }

  function openTerminal(){
    // evita duplicar
    if (screens.term.classList.contains("active")) return;

    showScreen("term");
    setStatus("SHELL", "acesso restrito");
    const who = sessionUser?.codename || "AGENTE";
    prompt.textContent = who.toUpperCase() + "@SV> ";

    termOut.textContent =
      "SV-SHELL iniciado.\n" +
      "Canal: contingência\n" +
      "Estado: degradado\n\n" +
      "Comandos disponíveis: status, sync, ping, help\n";

    termCmd.value = "";
    termCmd.focus();
  }

  function termWrite(line){
    termOut.textContent += line + "\n";
    termOut.scrollTop = termOut.scrollHeight;
  }

  function termFail(){
    const fails = (parseInt(localStorage.getItem(LS.termFails) || "0", 10) + 1);
    localStorage.setItem(LS.termFails, String(fails));
    termWrite("Erro: comando rejeitado (AUTH_CONTEXT_LOST).");
    termWrite("Falhas: " + fails + "/3");

    frame.classList.add("shake");
    setTimeout(()=>frame.classList.remove("shake"), 260);

    if (fails >= 3) {
      setLockState("hard");
      setStatus("LOCKED", "revogação total");
      showScreen("locked");
    }
  }

  function runCmd(){
    const raw = (termCmd.value || "").trim();
    if (!raw) return;
    termWrite(prompt.textContent + raw);
    termCmd.value = "";

    const cmd = raw.toLowerCase();

    if (cmd === "help") {
      termWrite("help  - lista comandos");
      termWrite("status - estado do canal");
      termWrite("ping   - teste de resposta");
      termWrite("sync   - iniciar sincronização");
      return;
    }

    if (cmd === "status") {
      termWrite("Estado: degradado");
      termWrite("Credencial: revogada");
      termWrite("Nó: instável");
      return;
    }

    if (cmd === "ping") {
      termWrite("Resposta: ...");
      termWrite("Timeout.");
      return termFail();
    }

    if (cmd === "sync") {
      termWrite("Iniciando sincronização...");
      termWrite("Falha: assinatura inválida.");
      termWrite("Conexão recusada.");
      return termFail();
    }

    // qualquer outro comando falha
    termFail();
  }

  // Events
  btnLogin.addEventListener("click", login);
  passIn.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });
  userIn.addEventListener("keydown", (e)=>{ if(e.key==="Enter") passIn.focus(); });

  btnLocContinue.addEventListener("click", () => {
    showScreen("chat");
    setStatus("ONLINE", "canal de texto");
    chatInit();
  });
  btnLocRetry.addEventListener("click", startLocation);

  btnSend.addEventListener("click", () => {
    const t = chatInput.value.trim();
    if (!t) return;
    addChatLine("[VOCÊ]", t);
    chatInput.value = "";
    // ao tentar transmitir, a Ordo corta
    setTimeout(() => cutConnection(), 400);
  });
  chatInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") btnSend.click(); });

  btnSync.addEventListener("click", breachFail);
  btnForce.addEventListener("click", breachFail);
  syncKey.addEventListener("keydown", (e)=>{ if(e.key==="Enter") breachFail(); });

  btnTermRun.addEventListener("click", runCmd);
  termCmd.addEventListener("keydown", (e)=>{ if(e.key==="Enter") runCmd(); });

  // Start
  boot();
})();
</script>
</body>
</html>
